<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/hais-notebook/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/hais-notebook/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hais-notebook/images/favicon-16x16.png">
  <link rel="mask-icon" href="/hais-notebook/images/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/hais-notebook/css/main.css">

<link rel="stylesheet" href="https://fonts.font.im/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/hais-notebook/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hyuain.github.io","root":"/hais-notebook/","images":"/hais-notebook/images","scheme":"Gemini","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac","show_result":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/hais-notebook/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/hais-notebook/js/config.js"></script>

    <meta name="description" content="翻译自 Angular Change Detection - How Does It Really Work? 。 Angular CD 是一个框架内置的特性，用于保证组件数据和 HTML 模板视图的同步。 CD 会检测常规的浏览器事件（比如点击）、HTTP 请求，以及其他类型的事件，并决定每个组件的视图是否需要更新，Angular 通过 Zone.js 来改写浏览器 API 来达到劫持事件的目的">
<meta property="og:type" content="article">
<meta property="og:title" content="翻译：Angular 如何检查变化">
<meta property="og:url" content="https://hyuain.github.io/hais-notebook/2021/05/17/Angular-ChangeDetection/index.html">
<meta property="og:site_name" content="Hais Notebook">
<meta property="og:description" content="翻译自 Angular Change Detection - How Does It Really Work? 。 Angular CD 是一个框架内置的特性，用于保证组件数据和 HTML 模板视图的同步。 CD 会检测常规的浏览器事件（比如点击）、HTTP 请求，以及其他类型的事件，并决定每个组件的视图是否需要更新，Angular 通过 Zone.js 来改写浏览器 API 来达到劫持事件的目的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/jhades/blog.angular-university.io/master/ng2-change-detection/images/change.jpg">
<meta property="article:published_time" content="2021-05-17T18:56:06.000Z">
<meta property="article:modified_time" content="2021-05-17T18:56:06.000Z">
<meta property="article:author" content="Harvey Zhang">
<meta property="article:tag" content="Notebook">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/jhades/blog.angular-university.io/master/ng2-change-detection/images/change.jpg">


<link rel="canonical" href="https://hyuain.github.io/hais-notebook/2021/05/17/Angular-ChangeDetection/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hyuain.github.io/hais-notebook/2021/05/17/Angular-ChangeDetection/","path":"2021/05/17/Angular-ChangeDetection/","title":"翻译：Angular 如何检查变化"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>翻译：Angular 如何检查变化 | Hais Notebook</title>
  






  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  <noscript>
    <link rel="stylesheet" href="/hais-notebook/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/hais-notebook/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hais Notebook</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/hais-notebook/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/hais-notebook/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/hais-notebook/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/hais-notebook/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cd-%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84"><span class="nav-number">2.</span> <span class="nav-text">CD 是如何实现的？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%87%8D%E5%86%99%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E9%BB%98%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="nav-number">3.</span> <span class="nav-text">重写浏览器的默认机制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%99%E4%B8%AA%E5%BA%95%E5%B1%82%E7%9A%84%E8%BF%90%E8%A1%8C%E6%97%B6%E6%9B%BF%E6%8D%A2%E6%98%AF%E6%80%8E%E6%A0%B7%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="nav-number">4.</span> <span class="nav-text">这个底层的运行时替换是怎样工作的？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%82%E6%AD%A5-api-%E6%94%AF%E6%8C%81"><span class="nav-number">5.</span> <span class="nav-text">浏览器异步 API 支持</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cd-%E6%A0%91"><span class="nav-number">6.</span> <span class="nav-text">CD 树</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#todoitem-%E7%9A%84-cdr-%E9%95%BF%E4%BB%80%E4%B9%88%E6%A0%B7%E5%AD%90"><span class="nav-number">7.</span> <span class="nav-text">TodoItem 的 CDr 长什么样子？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E7%9A%84-cd-%E6%9C%BA%E5%88%B6%E6%98%AF%E6%80%8E%E4%B9%88%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="nav-number">8.</span> <span class="nav-text">默认的 CD 机制是怎么工作的？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%B9%E4%BA%8E%E5%B5%8C%E5%A5%97%E5%AF%B9%E8%B1%A1-owner-%E5%8F%88%E6%80%8E%E4%B9%88%E6%A0%B7%E5%91%A2"><span class="nav-number">9.</span> <span class="nav-text">对于嵌套对象 owner 又怎么样呢？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-cd-%E9%BB%98%E8%AE%A4%E8%BF%99%E6%A0%B7%E5%B7%A5%E4%BD%9C"><span class="nav-number">10.</span> <span class="nav-text">为什么 CD 默认这样工作？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E6%AF%94%E8%BE%83%E5%BC%95%E7%94%A8"><span class="nav-number">11.</span> <span class="nav-text">为什么不比较引用？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%A6%82%E4%BD%95"><span class="nav-number">12.</span> <span class="nav-text">性能如何？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%88%E7%9C%8B%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%87%8C%E9%9D%A2%E6%98%AF%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84"><span class="nav-number">13.</span> <span class="nav-text">先看看虚拟机里面是什么样的</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#onpush-cd-%E6%A8%A1%E5%BC%8F"><span class="nav-number">14.</span> <span class="nav-text">OnPush CD 模式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#onpush-%E7%9C%9F%E7%9A%84%E5%8F%AA%E6%98%AF%E6%A3%80%E6%9F%A5%E5%BC%95%E7%94%A8%E5%90%97"><span class="nav-number">15.</span> <span class="nav-text">OnPush 真的只是检查引用吗？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-immutable.js-%E6%9D%A5%E7%AE%80%E5%8C%96-angular-%E5%BA%94%E7%94%A8%E7%9A%84%E6%9E%84%E5%BB%BA"><span class="nav-number">16.</span> <span class="nav-text">使用 Immutable.js 来简化 Angular 应用的构建</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%81%BF%E5%85%8D-cd-%E5%BE%AA%E7%8E%AF%E7%94%9F%E4%BA%A7%E6%A8%A1%E5%BC%8F-vs-%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="nav-number">17.</span> <span class="nav-text">避免 CD 循环：生产模式 vs 开发模式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%8E%E6%A0%B7%E5%9C%A8-angular-%E4%B8%AD%E8%A7%A6%E5%8F%91-cd-%E5%BE%AA%E7%8E%AF"><span class="nav-number">18.</span> <span class="nav-text">怎样在 Angular 中触发 CD 循环？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cd-issues-%E4%BC%9A%E5%BE%88%E9%A2%91%E7%B9%81%E5%90%97"><span class="nav-number">19.</span> <span class="nav-text">CD issues 会很频繁吗？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%80%E5%85%B3-cd%E5%B9%B6%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91%E4%BB%96"><span class="nav-number">20.</span> <span class="nav-text">开&#x2F;关 CD，并手动触发他</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Harvey Zhang</p>
  <div class="site-description" itemprop="description">海鲜酱的笔记本</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/hais-notebook/archives/">
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/hais-notebook/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hyuain.github.io/hais-notebook/2021/05/17/Angular-ChangeDetection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hais-notebook/images/avatar.gif">
      <meta itemprop="name" content="Harvey Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hais Notebook">
      <meta itemprop="description" content="海鲜酱的笔记本">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="翻译：Angular 如何检查变化 | Hais Notebook">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          翻译：Angular 如何检查变化
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-17 18:56:06" itemprop="dateCreated datePublished" datetime="2021-05-17T18:56:06+00:00">2021-05-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hais-notebook/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>翻译自 <a target="_blank" rel="noopener" href="https://blog.angular-university.io/how-does-angular-2-change-detection-really-work/">Angular Change Detection - How Does It Really Work?</a> 。</p>
<p>Angular CD 是一个框架内置的特性，用于保证组件数据和 HTML 模板视图的同步。</p>
<p><strong>CD 会检测常规的浏览器事件（比如点击）、HTTP 请求，以及其他类型的事件，并决定每个组件的视图是否需要更新，Angular 通过 Zone.js 来改写浏览器 API 来达到劫持事件的目的。</strong></p>
<p><strong>不同的 CD 模式</strong>：</p>
<ul>
<li><strong>Default CD</strong>：对于组件树中所有的组件，Angular 通过比较 template 中表达式的在事件前后的值，来决定视图是否更新</li>
<li><strong>OnPush CD</strong>：他会检查是否有新的数据确实地被推到了组件中（可以通过组件 input 或者使用 async pipe 订阅了的 Observable）</li>
</ul>
<p><strong>Angular 默认 CD 机制与 AngularJS 非常接近，他会检查 template 表达式在浏览器事件前后的值来看是否有变化。</strong>他对 <strong>所有</strong> 的组件都会这么做，但也有几点不同：</p>
<ul>
<li><strong>其一是 Angular 中没有 CD 循环</strong>（AngularJS 中叫 digest cycle）。这允许我们在只看 template 和 controller 的情况下能推导出每个组件。</li>
<li>其二是由于 CDr 是被构建出来的，Angular 中的 CD 机制会快很多。</li>
<li>第三是与 AngularJS 不同，Angular 中的 CD 机制是可定制的。</li>
</ul>
<span id="more"></span>
<blockquote>
<p>下文中 CD 指 Change Detection，即变化检查；CDr 指 Change Detector，即变化检查器</p>
</blockquote>
<h1 id="目录">目录</h1>
<ul>
<li>CD 是如何进行的？</li>
<li>Angular 的变化检查器是什么样的？</li>
<li>默认的 CD 机制是怎样进行的</li>
<li>开启/关闭 CD ，手动触发他</li>
<li>避开 CD 循环：生产模式和开发模式</li>
<li><code>OnPush</code> CD 模式究竟做了什么？</li>
<li>使用 Immutable.js 来简化 Angular 应用的构建</li>
</ul>
<p>如果想要了解更多关于 OnPush CD 机制，请查阅 <a target="_blank" rel="noopener" href="https://blog.angular-university.io/onpush-change-detection-how-it-works">这篇文章</a> 。</p>
<h1 id="cd-是如何实现的">CD 是如何实现的？</h1>
<p>当组件的数据变化的时候，Angular 可以探测到，并重新渲染视图来相应这次变化。为了理解工作原理，我们需要首先意识到 JavaScript 中整个运行时都是可重写的。我们可以重写类似于 <code>String</code> 或 <code>Number</code> 等方法。</p>
<h1 id="重写浏览器的默认机制">重写浏览器的默认机制</h1>
<p>Angular 启动的时候，将一些底层的的浏览器 API（比如浏览器用来注册事件的 <code>addEventListener</code>）替换掉，就像这样：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 这是新版的 addEventListener</span>
<span class="token keyword">function</span> <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 调用原生的 addEventListener</span>
  <span class="token function">callRealAddEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 先调用原生的 callback</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token comment">// 再运行 Angular 添加的功能</span>
    <span class="token keyword">var</span> changed <span class="token operator">=</span> angular<span class="token punctuation">.</span><span class="token function">runChangeDetection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      angular<span class="token punctuation">.</span><span class="token function">reRenderUIPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>新版的 <code>addEventListener</code> 会给事件处理器添加更多的功能：除了调用回调函数之外，还让 Angular 可以检测到变化并更新视图。</p>
<h1 id="这个底层的运行时替换是怎样工作的">这个底层的运行时替换是怎样工作的？</h1>
<p>一个叫 <a target="_blank" rel="noopener" href="https://github.com/angular/zone.js/">Zone.js</a> 的 Angular 自带的库完成了这个工作。</p>
<p>Zone 其实就是一个在多个 JavaScript 虚拟机执行回合之中幸存下来的执行上下文——这是一个可以用来为浏览器增加更多功能的很普遍的机制。Angular 内部使用 Zones 来触发 CD ，但 Zone 也可以用来做应用分析（比如内存占用、程序复杂度等）、跨越不同的 JavaScript 虚拟机回合进行长堆栈跟踪。</p>
<h1 id="浏览器异步-api-支持">浏览器异步 API 支持</h1>
<p>为了支持 CD ，下面这些常用的浏览器机制也被修改了：</p>
<ul>
<li>所有的浏览器事件（click、mouseover、keyup 等）</li>
<li><code>setTimeout()</code> 和 <code>setInterval()</code></li>
<li>Ajax HTTP 请求</li>
</ul>
<p>事实上，为了无感知地触发 Angular CD ，Zone.js 也修改了很多别的浏览器 API，比如 Websocket。可以看看 Zone.js 的 <a target="_blank" rel="noopener" href="https://github.com/angular/zone.js/tree/master/test/patch">一段测试代码</a> 看看现在支持了哪些 API。</p>
<p>这个机制的局限性在于：如果出于某些原因，Zone.js 不支持某个浏览器的异步 API，那么 CD 就不会被触发。比如 IndexedDB 的回调。</p>
<p>上面解释了 CD 是怎样触发的，但是触发之后他到底是怎样运作的呢？</p>
<h1 id="cd-树">CD 树</h1>
<p>在应用的启动阶段，每个 Angular 组件都与一个 CDr 建立关联。比如下面的 <code>TodoItem</code> 组件：</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  selector<span class="token operator">:</span> <span class="token string">'todo-item'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;span (click)="onToggle()" class="todo noselect">
      &#123;&#123;todo.owner.firstName&#125;&#125; - &#123;&#123;todo.description&#125;&#125; - completed: &#123;&#123;todo.completed&#125;&#125;
    &lt;/span>
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TodoItem</span> <span class="token punctuation">&#123;</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  todo<span class="token operator">:</span> Todo
  
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Output</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  toggle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter<span class="token operator">&lt;</span>Object<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token function">onToggle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>toggle<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>todo<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个组件会接受一个 <code>Todo</code> 对象作为输入，并且当 todo 状态发生改变的时候发出一个事件。来搞点花样，<a target="_blank" rel="noopener" href="https://github.com/jhades/blog.angular-university.io/blob/master/ng2-change-detection/src/todo.ts#L11">Todo class</a> 里面还嵌套了一个对象：</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Todo</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">public</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span> description<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span> completed<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span> owner<span class="token operator">:</span> Owner <span class="token comment">// 嵌套了 Owner 对象</span>
  <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Todo</code> 有一个属性 <code>owner</code>，<code>owner</code> 也是一个对象（有属性 <code>firstName</code> 和 <code>lastName</code>）。</p>
<h1 id="todoitem-的-cdr-长什么样子">TodoItem 的 CDr 长什么样子？</h1>
<p>事实上，我们可以在运行时看到 CDr 长什么样子！我们只需要在 Todo class 里面加一些代码来在访问他的属性的时候 <a target="_blank" rel="noopener" href="https://github.com/jhades/blog.angular-university.io/blob/master/ng2-change-detection/src/todo.ts#L11">打一个断点</a> 。</p>
<p>到达断点的时候，我们可以跟着调用栈看到 CDr：</p>
<p><img src="https://raw.githubusercontent.com/jhades/blog.angular-university.io/master/ng2-change-detection/images/change.jpg" /></p>
<p>别担心，你不需要去 debug 这些代码。这里也没有引入什么魔法，他只是一个在应用的启动阶段创建的简单的 Javascript 方法。但是他到底做了什么呢？</p>
<h1 id="默认的-cd-机制是怎么工作的">默认的 CD 机制是怎么工作的？</h1>
<p>这个方法最开始看起来可能非常奇怪，还有一些奇怪名字的变量。但是我们来仔细看看，可以注意到他在做一些非常简单的事情：他会比较每个表达式中使用的属性现在和之前的值，如果一个属性现在和之前的值不一样，他会将 <code>isChanged</code> 设为 <code>true</code>。</p>
<p>它使用了 <code>looseNotIdentical()</code> 来比较两个值，<a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/50548fb5655bca742d1056ea91217a3b8460db08/modules/angular2/src/facade/lang.ts#L367">这个方法</a> 使用了 <code>===</code> 运算符，并且对 <code>NaN</code> 进行了一些特殊处理。</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">looseIdentical</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> a <span class="token operator">===</span> b <span class="token operator">||</span> <span class="token keyword">typeof</span> a <span class="token operator">===</span> <span class="token string">"number"</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> b <span class="token operator">===</span> <span class="token string">"number"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="对于嵌套对象-owner-又怎么样呢">对于嵌套对象 <code>owner</code> 又怎么样呢？</h1>
<p>我们可以看到在 CDr 的代码中，<code>owner</code> 中的对象也被检查了，但是只检查了 <code>firstName</code>，并没有检查 <code>lastName</code>。</p>
<p>这是因为 <code>lastName</code> 并没有被 template 使用！——同样地，Todo 中的 <code>id</code> 属性也没有被检查。</p>
<p>对此，我们可以说：</p>
<blockquote>
<p>默认情况下，Angular CD 是检查 template 表达式中的值是否变化。他会检查所有的组件。</p>
</blockquote>
<p>我们也可以总结一下：</p>
<blockquote>
<p>默认情况下，Angular 不会做对象的深比较来检查便捷化，他只会关心在 template 中使用的属性。</p>
</blockquote>
<h1 id="为什么-cd-默认这样工作">为什么 CD 默认这样工作？</h1>
<p>Angular 的主要目标之一就是变得更透明和易用，因此框架的使用者不需要为了更有效率地使用它而去进行很冗长的 debug 或者了解他的内部机制。</p>
<p>如果你熟悉 AngularJs，想一下 <code>$digest()</code> 和 <code>$apply()</code> 以及所有使用/不使用他们的时候的坑。Angular 的主要目标之一就是避免他们。</p>
<h1 id="为什么不比较引用">为什么不比较引用？</h1>
<p>事实上，Javascript 的对象都是可变的，Angular 想要对此给予全力的支持。</p>
<p>想象一下如果 Angular 默认 CD 机制是基于组件输入的引用的比较（而不是默认的机制）。这样的话即便是像 TODO 这样简单的应用都需要一些技巧来创建：开发者需要非常小心地来创建一个新的 Todo，而不是只是更新属性。</p>
<p>但就像我们将要看到的那样，如果有必要的话，也可以自定义 Angular 的CD 。</p>
<h1 id="性能如何">性能如何？</h1>
<p>注意 TodoList 组件的CD 器是怎样创建对 <code>todos</code> 属性的显式引用的。</p>
<p>另一个方法是动态地遍历组件的属性，让代码具有普遍性（generic）——而不是为了这个组件特异化（specific）。这样我们就不用在每次组件创建的时候都创建一个CD 器了！所以应该怎么做呢？</p>
<h1 id="先看看虚拟机里面是什么样的">先看看虚拟机里面是什么样的</h1>
<p>上面说的一切都与 Javascript 虚拟机有关。进行动态比较的代码并不能被虚拟机即时编译器（VM just-in-time compiler）优化为本地代码（native code）。</p>
<p>特异化的代码对每个组件输入的属性有非常明确的访问，他们就像我们自己写的代码一样，而且虚拟机可以非常轻松地将他们转换为本地代码。</p>
<p>用生成的特异化 CDr 的结果就是：会非常快、可预测和易读。</p>
<p>接下来我们来讨论一下性能，有办法可以优化 CD 吗？</p>
<h1 id="onpush-cd-模式"><code>OnPush</code> CD 模式</h1>
<p>如果我们的 Todo 列表非常的大，我们可以配置这个 <code>TodoList</code> 组件，使用 <code>OnPush</code> 策略，让他只有在 Todo 列表变化的时候才会更新自己。</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  selector<span class="token operator">:</span> <span class="token string">"todo-list"</span><span class="token punctuation">,</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush<span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TodoList</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后在整个列表外面加两个按钮：</p>
<ul>
<li>一个按钮直接修改 TodoItem，来改变他的状态</li>
<li>一个按钮给整个 TodoList 增加一个新的 TodoItem</li>
</ul>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  selector<span class="token operator">:</span> <span class="token string">"app"</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;div>
    &lt;todo-list [todos]="todos">&lt;/todo-list>
  &lt;/div>
  &lt;button (click)="toggleFirst()">Toggle First Item&lt;/button>
  &lt;button (click)="addTodo()">Add Todo to List&lt;/button>
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">&#123;</span>
  todos<span class="token operator">:</span> <span class="token builtin">Array</span> <span class="token operator">=</span> initialData

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

  <span class="token function">toggleFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>todos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>completed <span class="token operator">=</span> <span class="token operator">!</span> <span class="token keyword">this</span><span class="token punctuation">.</span>todos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>completed
  <span class="token punctuation">&#125;</span>

  <span class="token function">addTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> newTodos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>todos<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    newTodos<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Todo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"TODO 4"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Owner</span><span class="token punctuation">(</span><span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string">"Doe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>todos <span class="token operator">=</span> newTodos
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>来看看他们不同的表现：</p>
<ul>
<li>第一个按钮 "Toggle First Item" 没有起作用！因为 <code>toggleFirst()</code> 函数直接改变了列表的第一个元素。<code>TodoList</code>。<code>TodoList</code> 无法检测到这个这个变化，因为输入的 <code>todos</code> 引用没有发生变化</li>
<li>第二个按钮生效了！注意 <code>addTodo()</code> 创建了一个 todo list 的副本，然后在这个副本上增加一个项，最后用这个副本替代掉原来的 todos。因为输入的 todos 的引用发生了变化，这就触发了检查。</li>
<li>第二个按钮中，直接修改这个 todo list 是不会生效的，我们需要一个新的 list</li>
</ul>
<h1 id="onpush-真的只是检查引用吗"><code>OnPush</code> 真的只是检查引用吗？</h1>
<p>这不是问题，就算你将 <code>TodoItem</code> 也改成 <code>OnPush</code> 模式，你仍然可以做到只是点击一个 todo 就 toggle 他。</p>
<p>因为 <code>OnPush</code> 不只是在组件输入变化的时候进行检查，组件触发的事件同样会触发CD 。</p>
<p>正如 Victor Savkin 在他的博客中所说：</p>
<blockquote>
<p>如果使用 OnPush 检查器的时候，框架会在他输入的属性变化的时候、他发出事件的时候、Observable 触发事件的时候，检查 OnPush 组件</p>
</blockquote>
<p>尽管 <code>OnPush</code> 可能会使得性能更好，在使用可变对象时，他的引入会带来更高的复杂度。这会引发一些很难找到原因和重现的 BUG。但是也有可以灵活使用 <code>OnPush</code> 的方法。</p>
<h1 id="使用-immutable.js-来简化-angular-应用的构建">使用 <code>Immutable.js</code> 来简化 Angular 应用的构建</h1>
<p>如果我们只用不可变的对象和列表来构建应用，我们显然就可以在任何地方使用 <code>OnPush</code> 了，并且不会导致 CD 的 BUG。这是因为“修改”不可变对象的唯一方法是创建一个新的对象来替代它。 对于不可变对象，我们可以保证：</p>
<ul>
<li>一个新的不可变对象永远都会触发 <code>OnPush</code> 的 CD</li>
<li>不可能产生因为忘记创建一个对象的新副本而引发的错误</li>
</ul>
<p>用 Immutable.js 库是个不错的选择，这个库提供了构建应用的基础，比如不可变对象、Map、列表等。</p>
<h1 id="避免-cd-循环生产模式-vs-开发模式">避免 CD 循环：生产模式 vs 开发模式</h1>
<p>Angular CD 的一个重要特性就是，与 AngluarJS 不同，他强制使用单向数据流：当我们的 controller 更新的时候，CD 会运行并更新 view。</p>
<p>但是更新 view 并不会触发变化（变化又会触发新的视图更新，在 AngularJS 中这被称为 digest cycle）。</p>
<h1 id="怎样在-angular-中触发-cd-循环">怎样在 Angular 中触发 CD 循环？</h1>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  selector<span class="token operator">:</span> <span class="token string">'todo-list'</span><span class="token punctuation">,</span>
  directives<span class="token operator">:</span> <span class="token punctuation">[</span>TodoItem<span class="token punctuation">]</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;ul>
                &lt;li *ngFor="#todo of todos;">
                    &lt;todo-item [todo]="todo" (toggle)="onToggle($event)">&lt;/todo-item>
                &lt;/li>
           &lt;/ul>
           &lt;button (click)="blowup()">Trigger Change Detection Loop&lt;/button></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TodoList</span> <span class="token keyword">implements</span> <span class="token class-name">AfterViewChecked</span> <span class="token punctuation">&#123;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  todos<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Todo<span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  callback<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Output</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  addTodo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter<span class="token operator">&lt;</span>Object<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  clicked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token function">onToggle</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"toggling todo.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    todo<span class="token punctuation">.</span>completed <span class="token operator">=</span> <span class="token operator">!</span>todo<span class="token punctuation">.</span>completed<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">blowup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Trying to blow up change detection..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clicked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>addTodo<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">ngAfterViewChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clicked<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"changing status ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一种情况是使用生命周期钩子：比如在 <code>TodoList</code> 组件中，我们可以在 <code>ngAfterViewChecked</code> 中通过回调函数去改变另外一个组件绑定的值，这时候就会得到一个警告：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">EXCEPTION: Expression '&#123;&#123;message&#125;&#125; in App@3:20' has changed after it was checked<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个错误只有在开发模式下会出现，在生产模式下将不会抛错，这个 issue 也不会被检测到。</p>
<h1 id="cd-issues-会很频繁吗">CD issues 会很频繁吗？</h1>
<p>事实上我们不应该触发 CD 循环，以防万一，我们我们在开发阶段应该一直使用开发模式来避免这个问题。 因为 Angular 在开发模式下，总是会进行两次 CD（第二次就是用来检测这个问题）；而在生产模式下，CD 只会执行一次。</p>
<h1 id="开关-cd并手动触发他">开/关 CD，并手动触发他</h1>
<p>在一些特殊的情况下，我们不想触发 CD。设想这样一种情况，我们从后端通过 Websocket 拿到了大量的数据，我们想要每 5 秒钟更新 UI 的一部分。为了达成这个目的，我们需要在最开始的时候注入 CDr：</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> ref<span class="token operator">:</span> ChangeDetectorRef<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ref<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ref<span class="token punctuation">.</span><span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们最开始 detach 了 CDr（这会关闭自动的 CD），然后每 5 秒通过 <code>detectChanges</code> 手动触发一次。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/hais-notebook/2021/05/14/RxJS-Trick/" rel="prev" title="RxJS 小技巧">
                  <i class="fa fa-chevron-left"></i> RxJS 小技巧
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/hais-notebook/2021/07/11/Course-ComputationStructures/" rel="next" title="在线课程：计算机组成原理">
                  在线课程：计算机组成原理 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Harvey Zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="/hais-notebook/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/hais-notebook/js/comments.js"></script><script src="/hais-notebook/js/utils.js"></script><script src="/hais-notebook/js/next-boot.js"></script>

  <script src="/hais-notebook/lib/hexo-generator-searchdb/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/hais-notebook/js/third-party/search/local-search.js"></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"/hais-notebook/lib/mathjax/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/hais-notebook/js/third-party/math/mathjax.js"></script>



</body>
</html>
