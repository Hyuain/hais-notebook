---
title: Limited Direct Execution
date: 2024-01-15 21:37:30
categories:
  - - 计算机
tags:
  - CX
---

为了实现 CPU 虚拟化，操作系统需要让一些看似同时运行的任务共享虚拟 CPU。简单的方法是通过 **分时（Time Sharing）**，先运行一个进程一段时间，然后再运行另一个进程一段时间。但构建此类虚拟化机器时会面临一些挑战，其中的核心保持操作系统控制得同时获得更高的性能。

**有限直接执行（Limited Direct Execution）** 是一种操作系统设计中的概念和技术。他在保持操作系统对资源的控制、安全性与进程隔离的同时，不引入太多操作系统的干预，从而减少性能开销。

他包括以下概念：

- **直接执行（Direct Execution）**：当操作系统想要运行某个程序时，他为其在进程列表中创建一个条目、分配一些内存、将其代码从磁盘加载到内存中、找到他的入口（比如 `main()` 函数），然后跳转到入口开始运行用户代码
- **权限限制（Limited Privileges）**：CPU 至少支持两种执行模式，一种是受限的 **用户模式（User Model）**，一种是不受限的、或者说有特权的（Privileged）**内核模式（Kernel Model）**。用户程序不能直接执行 I/O 操作、访问受保护的内存等操作
- **陷阱（Trap）**
	- 典型的用户程序在用户模式下运行，并使用 **系统调用（System Call）** 来 **陷入（Trap Into）** 内核，请求操作系统的服务
	- Trap 指令会保存寄存器状态、将硬件状态切换到内核模式，并跳转到操作系统中由 **陷阱表（Trap Table）** 预定义好的位置
	- OS 执行完系统调用之后，通过 return-from-trap 指令减少权限并将控制权交还给给 Trap 之后的下一条指令
	- Trap Table 必须在 OS 启动的时候设置，并保证其不能被用户程序轻易修改
- 程序运行的时候，有两个方式可以将控制权重新交给 OS
	- **合作方式（Cooperative Approach）**：程序主动调用系统调用将控制权交给 OS，在早期系统中有所使用，这类 OS 通常会提供 yield 之类的系统调用，程序调用此方法交出控制权
	- **非合作方式（Non-Cooperative Approach）**：不能确保用户程序程序都那么老实，操作系统得使用名为 **定时器中断（Timer Interrupt）** 的硬件机制来保证用户程序不会一直运行下去
- 有时候在系统调用或定时器中断时，希望从当前运行的进程切换到另一个，这时使用的底层技术叫 **上下文切换（Context Switch）**

